name: Starbugs CI/CD

on:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SONAR_URL: "http://54.144.238.57:8081"
      NEXUS_URL: "http://54.144.238.57:8082"
      NEXUS_REPO: "starbugs-app"
      NEXUS_GROUP: "com/web/starbugs"
      NEXUS_ARTIFACT: "starbugs-app"
      NGINX_HOST: "54.144.238.57"
      VERSION: "0.0.${{ github.run_number }}"
      DOCKER_IMAGE: "reddi122/starbugs-app:${{ github.run_number }}"

    steps:
      # ------------------------------
      # 1. Checkout Code
      # ------------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      # ------------------------------
      # 2. Install Dependencies
      # ------------------------------
      - name: Install Node dependencies
        run: npm install

      # ------------------------------
      # 3. SonarQube Analysis
      # ------------------------------
      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          wget -q -O sonar.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -qo sonar.zip
          export PATH=$(pwd)/sonar-scanner-5.0.1.3006-linux/bin:$PATH

          sonar-scanner \
            -Dsonar.projectKey=starbugs-react \
            -Dsonar.sources=src \
            -Dsonar.host.url=${SONAR_URL} \
            -Dsonar.login=${SONAR_TOKEN} \
            -Dsonar.projectVersion=${VERSION}

      # ------------------------------
      # 4. Build React App
      # ------------------------------
      - name: Build React App
        run: npm run build

      # ------------------------------
      # 5. Package build artifact
      # ------------------------------
      - name: Create tar.gz Package
        run: |
          mkdir -p packaged
          tar -czf packaged/${NEXUS_ARTIFACT}-${VERSION}.tar.gz -C dist .

      # ------------------------------
      # 6. Upload to Nexus
      # ------------------------------
      - name: Upload Artifact to Nexus
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          curl -v -u ${NEXUS_USER}:${NEXUS_PASS} \
            --upload-file "packaged/${NEXUS_ARTIFACT}-${VERSION}.tar.gz" \
            "${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${NEXUS_ARTIFACT}-${VERSION}.tar.gz"

      # ------------------------------
      # 7. Docker Login
      # ------------------------------
      - name: Docker Login
        run: echo ${{ secrets.DOCKERHUB_PASS }} | docker login -u ${{ secrets.DOCKERHUB_USER }} --password-stdin

      # ------------------------------
      # 8. Download artifact from Nexus and Build Docker image
      # ------------------------------
      - name: Build Docker Image
        run: |
          DOWNLOAD_URL="${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${NEXUS_ARTIFACT}-${VERSION}.tar.gz"
          curl -f -o app.tar.gz ${DOWNLOAD_URL}

          docker build -t ${DOCKER_IMAGE} .

      # ------------------------------
      # 9. Push to DockerHub
      # ------------------------------
      - name: Push Docker Image
        run: docker push ${DOCKER_IMAGE}

      # ------------------------------
      # 10. SSH to EC2 & Deploy Container
      # ------------------------------
      - name: Deploy to EC2 Over SSH
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.NGINX_HOST }}
          username: ubuntu
          key: ${{ secrets.NGINX_SSH_KEY }}
          script: |
            docker rm -f starbugs-app || true
            docker pull ${DOCKER_IMAGE}
            docker run -d --name starbugs-app -p 80:80 ${DOCKER_IMAGE}
