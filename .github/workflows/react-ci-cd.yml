name: Starbugs CI/CD

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SONAR_URL: "http://54.144.238.57:8081"
      NEXUS_URL: "http://54.144.238.57:8082"
      NEXUS_REPO: "starbugs-app"
      NEXUS_GROUP: "com/web/starbugs"
      NEXUS_ARTIFACT: "starbugs-app"
      NGINX_HOST: "54.144.238.57"
      VERSION: "0.0.${{ github.run_number }}"
      DOCKER_IMAGE: "reddi122/starbugs-app:${{ github.run_number }}"

    steps:
      # ------------------------------------------------------
      # 1. Checkout Code
      # ------------------------------------------------------
      - name: Checkout Code
        uses: actions/checkout@v3

      # ------------------------------------------------------
      # 2. Install Dependencies
      # ------------------------------------------------------
      - name: Install Dependencies
        run: npm install

      # ------------------------------------------------------
      # 3. SonarQube Analysis
      # ------------------------------------------------------
      - name: SonarQube Scan
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          wget -q -O sonar.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip -qo sonar.zip
          export PATH=$(pwd)/sonar-scanner-5.0.1.3006-linux/bin:$PATH

          sonar-scanner \
            -Dsonar.projectKey=starbugs-react \
            -Dsonar.sources=src \
            -Dsonar.host.url=${SONAR_URL} \
            -Dsonar.login=${SONAR_TOKEN} \
            -Dsonar.projectVersion=${VERSION}

      # ------------------------------------------------------
      # 4. Build React Application
      # ------------------------------------------------------
      - name: Build React App
        run: npm run build

      # ------------------------------------------------------
      # 5. package into tar.gz
      # ------------------------------------------------------
      - name: Package Artifact
        run: |
          mkdir -p packaged
          tar -czf packaged/${NEXUS_ARTIFACT}-${VERSION}.tar.gz -C dist .

      # ------------------------------------------------------
      # 6. Upload to Nexus
      # ------------------------------------------------------
      - name: Upload to Nexus
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          curl -u ${NEXUS_USER}:${NEXUS_PASS} \
            --upload-file "packaged/${NEXUS_ARTIFACT}-${VERSION}.tar.gz" \
            "${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${NEXUS_ARTIFACT}-${VERSION}.tar.gz"

      # ------------------------------------------------------
      # 7. Docker login
      # ------------------------------------------------------
      - name: Docker Login
        run: |
          echo "${{ secrets.DOCKERHUB_PASS }}" | docker login -u "${{ secrets.DOCKERHUB_USER }}" --password-stdin

      # ------------------------------------------------------
      # 8. Download artifact & Build Docker image
      # ------------------------------------------------------
      - name: Build Docker Image
        run: |
          ART_URL="${NEXUS_URL}/repository/${NEXUS_REPO}/${NEXUS_GROUP}/${NEXUS_ARTIFACT}/${VERSION}/${NEXUS_ARTIFACT}-${VERSION}.tar.gz"
          curl -o app.tar.gz "$ART_URL"
          docker build -t ${DOCKER_IMAGE} .

      # ------------------------------------------------------
      # 9. Push Docker image
      # ------------------------------------------------------
      - name: Push Docker Image
        run: docker push ${DOCKER_IMAGE}

      # ------------------------------------------------------
      # 10. SSH â†’ Deploy on EC2 (Corrected Version)
      # ------------------------------------------------------
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.NGINX_HOST }}
          username: ubuntu
          key: ${{ secrets.NGINX_SSH_KEY }}
          envs: DOCKER_IMAGE   # ðŸ‘ˆ THIS IS THE FIX
          script: |
            docker rm -f starbugs-app || true
            docker pull $DOCKER_IMAGE
            docker run -d --name starbugs-app -p 80:80 $DOCKER_IMAGE
